trigger:
  branches:
    include:
      - develop

pool:
  vmImage: 'ubuntu-latest'

stages:
  - stage: Setup
    displayName: "Setup Environment"
    jobs:
      - job: Setup
        displayName: "Install Dependencies"
        steps:
          # Instalar Python en la VM del agente
          - task: UsePythonVersion@0
            inputs:
              versionSpec: '3.x'
          
          # Crear entorno virtual y descargar dependencias
          - script: |
              python -m venv env  # Crear entorno virtual en la carpeta raíz
              source env/bin/activate
              pip install -r task_manager/requirements.txt
            displayName: "Setup Python environment and install dependencies"

  - stage: LintAndTests
    displayName: "Run Linter and Tests"
    dependsOn: Setup
    jobs:
      - job: LintAndTests
        displayName: "Run linter and tests"
        steps:
          # Crear entorno virtual, instalar dependencias y el paquete principal `task_manager`
          - script: |
              source env/bin/activate
              pip install -r task_manager/requirements.txt
              pip install -e task_manager/
            displayName: "Setup virtual environment and install `task_manager`"

          # Ejecutar flake8 para analizar el código
          - script: |
              source env/bin/activate
              pip install flake8
              flake8 . --exclude=env,task_manager/env --count --select=E9,F63,F7,F82 --show-source --statistics
            displayName: "Run flake8 linter"

          # Ejecutar pytest con cobertura y generar reporte XML
          - script: |
              source env/bin/activate
              pip install pytest pytest-cov
              pytest --cov=task_manager --cov-report=xml --cov-report=term-missing --junitxml=task_manager/test-results.xml
            displayName: "Run pytest and generate coverage report"

          # Publicar los resultados de las pruebas como artefactos del pipeline
          - task: PublishPipelineArtifact@1
            inputs:
              targetPath: 'task_manager'
              artifactName: 'test-results'
              publishLocation: 'Container'
            displayName: "Publish Test Results"

  - stage: SonarCloudAnalysis
    displayName: "SonarCloud Analysis"
    dependsOn: LintAndTests
    jobs:
      - job: SonarCloud
        displayName: "Analyze code with SonarCloud"
        steps:
          - task: UsePythonVersion@0
            inputs:
              versionSpec: '3.x'

          # Preparar la configuración de SonarCloud
          - task: SonarCloudPrepare@2
            inputs:
              SonarCloud: 'SonarCloud'  # Reemplazar con el nombre de tu Service Connection
              organization: 'unisabaneta'  # Reemplazar con tu organización
              scannerMode: 'CLI'
              configMode: 'manual'
              cliProjectKey: 'unisabaneta_sag-unisabaneta'  # Reemplazar con tu llave de proyecto
              cliProjectName: 'SAG-UNISABANETA'  # Reemplazar con el nombre de tu proyecto
              cliSources: '.'
              extraProperties: |
                sonar.python.coverage.reportPaths=task_manager/coverage.xml  # Ruta del reporte de cobertura XML

          # Instalar dependencias adicionales si es necesario para el análisis
          - script: |
              source env/bin/activate
              pip install -r task_manager/requirements.txt
            displayName: "Install dependencies for SonarCloud analysis"

          # Ejecutar el análisis de SonarCloud
          - task: SonarCloudAnalyze@2
            displayName: "Run SonarCloud analysis"

          # Publicar los resultados del análisis de SonarCloud
          - task: SonarCloudPublish@2
            displayName: "Publish SonarCloud results"

  - stage: PublishArtifacts
    displayName: "Publish Build Artifacts"
    dependsOn: SonarCloudAnalysis
    jobs:
      - job: Publish
        displayName: "Publish Build Artifacts"
        steps:
          - task: PublishPipelineArtifact@1
            inputs:
              targetPath: '$(System.DefaultWorkingDirectory)'
              artifactName: 'build-artifacts'
              publishLocation: 'Container'
            displayName: "Publish build artifacts"
